<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Festa da Mait√™</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --rosa: #d63384;
    --rosa-escuro: #ad2a6b;
    --verde: #28a745;
    --cinza-borda: #dcdcdc;
    --bg-grad: linear-gradient(135deg, #ffe0f0, #ffc4e1);
    --card-bg: #fff;
    --radius-card: 18px;
    --radius-btn: 8px;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-grad);
    min-height: 100vh;
    color: #333;
  }

  /* Layout base */
  .center-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 16px;
    text-align: center;
  }

  .card {
    background: var(--card-bg);
    padding: 32px 28px;
    border-radius: var(--radius-card);
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    max-width: 500px;
    margin: 16px;
  }

  h1, h2, h3 {
    margin-top: 0;
    font-weight: 600;
  }
  h1 { color: var(--rosa); font-size: 1.9rem; }
  h2 { color: var(--rosa); font-size: 1.4rem; }
  h3 { color: var(--rosa); font-size: 1.1rem; margin-bottom: 8px; }

  p { line-height: 1.4; margin: 0 0 1em; }

  /* Bot√µes gen√©ricos */
  .btn {
    background-color: var(--rosa);
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius-btn);
    font-size: 16px;
    cursor: pointer;
    margin-top: 16px;
  }
  .btn:hover { background-color: var(--rosa-escuro); }

  /* Bot√£o Login (fixo, s√≥ na home) */
  #loginBtn {
    position: fixed;
    top: 16px;
    left: 16px;
    background: rgba(255,255,255,0.7);
    color: var(--rosa);
    font-weight: bold;
    border: 2px solid var(--rosa);
    border-radius: 30px;
    padding: 6px 18px;
    cursor: pointer;
    z-index: 1000;
    font-size: 14px;
  }
  #loginBtn:hover {
    background: rgba(255,255,255,0.9);
  }

  /* Admin overlay */
  #adminArea {
    display: none;
    position: fixed;
    inset: 0;
    background: #fff8fc;
    z-index: 999;
    padding: 40px 16px 80px;
    overflow-y: auto;
  }

  .admin-inner {
    max-width: 700px;
    margin: 0 auto;
  }

  .closeBtn {
    position: absolute;
    top: 10px;
    right: 20px;
    background: transparent;
    font-size: 32px;
    line-height: 1;
    border: none;
    color: var(--rosa);
    cursor: pointer;
  }

  label {
    display: block;
    font-size: 0.95rem;
    font-weight: 600;
    margin: 16px 0 4px;
    color: var(--rosa-escuro);
  }

  input, textarea {
    width: 100%;
    font-size: 1rem;
    padding: 10px 12px;
    margin-bottom: 8px;
    border: 1px solid var(--cinza-borda);
    border-radius: var(--radius-btn);
    box-sizing: border-box;
  }
  textarea { min-height: 60px; resize: vertical; }

  .admin-actions {
    margin-top: 16px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .admin-btn {
    padding: 8px 14px;
    font-size: 14px;
    border-radius: var(--radius-btn);
    border: none;
    cursor: pointer;
  }
  .admin-btn.add { background: var(--rosa); color: #fff; }
  .admin-btn.mass { background: var(--verde); color: #fff; }
  .admin-btn.mass:hover { filter: brightness(0.9); }

  /* Bot√£o voltar (novo) */
  #voltarBtn {
    background: var(--rosa);
    color: #fff;
    padding: 12px 20px;
    border: none;
    border-radius: var(--radius-btn);
    font-size: 16px;
    cursor: pointer;
    margin-top: 24px;
  }
  #voltarBtn:hover {
    background: var(--rosa-escuro);
  }

  /* Lista de fam√≠lias */
  #familiasContainer {
    margin-top: 24px;
  }
  .familyBox {
    border: 1px dashed var(--cinza-borda);
    padding: 16px;
    margin-bottom: 12px;
    border-radius: var(--radius-card);
    background: #ffffff;
    position: relative;
  }
  .familyBox strong {
    font-size: 1.1rem;
    color: var(--rosa-escuro);
  }
  .familyBox p {
    margin: 4px 0;
    font-size: 0.95rem;
  }

  .fam-actions {
    margin-top: 8px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .fam-btn {
    padding: 6px 12px;
    font-size: 13px;
    border: none;
    border-radius: var(--radius-btn);
    cursor: pointer;
  }
  .fam-send { background: var(--verde); color: #fff; }
  .fam-edit { background: #ffc107; color: #000; }
  .fam-delete { background: #dc3545; color: #fff; }

  .fam-btn:hover { filter: brightness(0.9); }

  /* Edit modal */
  #editModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 1001;
    justify-content: center;
    align-items: center;
    padding: 16px;
  }
  .edit-content {
    background: #fff;
    max-width: 420px;
    width: 100%;
    padding: 24px;
    border-radius: var(--radius-card);
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    position: relative;
  }
  .edit-close {
    position: absolute;
    top: 8px;
    right: 12px;
    background: transparent;
    border: none;
    font-size: 24px;
    color: var(--rosa);
    cursor: pointer;
  }
  .edit-save {
    margin-top: 16px;
    width: 100%;
    background: var(--rosa);
    color: #fff;
    padding: 10px;
    font-size: 16px;
    border: none;
    border-radius: var(--radius-btn);
    cursor: pointer;
  }
  .edit-save:hover { background: var(--rosa-escuro); }

  /* Responsividade menor */
  @media (max-width:480px) {
    .card { padding: 24px 20px; }
    h1 { font-size: 1.6rem; }
    .btn, #voltarBtn { width: 100%; }
  }
</style>
</head>
<body>

<!-- Bot√£o Login (fixo, s√≥ na home) -->
<button id="loginBtn" type="button">LOGIN</button>

<!-- TELA HOME -->
<div id="homeView" class="center-wrap" >
  <div class="card">
    <h1>Festa da Mait√™ üéâ</h1>
    <p>Estamos muito felizes em celebrar o 1¬∫ aninho da nossa princesa Mait√™! üíú</p>
    <p>
      Mam√£e ou papai, estamos muito felizes em ajudar voc√™s com a festa da Mait√™!<br>
      Este espa√ßo foi personalizado para facilitar o envio dos convites, acompanhar as confirma√ß√µes de presen√ßa e tornar esse momento ainda mais especial.
    </p>
    <button id="acessoBtn" class="btn" type="button">Acesso</button>
  </div>
</div>

<!-- TELA CONFIRMA√á√ÉO (quando vem com ?familia=... ) -->
<div id="confirmView" class="center-wrap" hidden>
  <div class="card" id="confirmCard">
    <h1>Mait√™ faz 1 aninho! üëßüéâ</h1>
    <p id="familiaSaudacao"></p>
    <p>
      üóìÔ∏è <strong>Data:</strong> 20 de Setembro<br>
      üïí <strong>Hor√°rio:</strong> das 19:30 √†s 23:30<br>
      üìç <strong>Local:</strong> Avenida S√£o Miguel, 8001 - SP
    </p>
    <button id="confirmarBtn" class="btn" type="button">Confirmar Presen√ßa</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminArea" hidden>
  <button class="closeBtn" type="button" aria-label="Fechar Admin">&times;</button>
  <div class="admin-inner">
    <h2>Cadastro de Fam√≠lias</h2>

    <div class="admin-form">
      <label for="responsavel">Respons√°vel (Ex: Sueli)</label>
      <input id="responsavel" placeholder="Respons√°vel" />

      <label for="membros">Membros (Ex: Sueli, Adilson, Eduardo)</label>
      <textarea id="membros" placeholder="Membros separados por v√≠rgula"></textarea>

      <label for="telefone">Telefone com DDD (somente n√∫meros)</label>
      <input id="telefone" placeholder="Ex: 11999999999" />

      <div class="admin-actions">
        <button class="admin-btn add" type="button" id="addFamiliaBtn">Adicionar Fam√≠lia</button>
        <button class="admin-btn mass" type="button" id="sendAllBtn">Encaminhar Todos</button>
        <button class="admin-btn mass" type="button" id="exportBtn" title="Exportar em CSV">Exportar CSV</button>
      </div>
    </div>

    <div id="familiasContainer"></div>

    <!-- Bot√£o voltar para a tela inicial -->
    <button id="voltarBtn" type="button">Voltar √† tela inicial</button>
  </div>
</div>

<!-- MODAL EDI√á√ÉO -->
<div id="editModal">
  <div class="edit-content">
    <button class="edit-close" type="button" aria-label="Fechar edi√ß√£o">&times;</button>
    <h3>Editar Fam√≠lia</h3>
    <label for="editResponsavel">Respons√°vel</label>
    <input id="editResponsavel" />
    <label for="editMembros">Membros</label>
    <textarea id="editMembros"></textarea>
    <label for="editTelefone">Telefone</label>
    <input id="editTelefone" />
    <button class="edit-save" type="button" id="editSaveBtn">Salvar Altera√ß√µes</button>
  </div>
</div>

<script>
/* UTILIDADES */
function $(id) { return document.getElementById(id); }

function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    familia: params.get('familia'),
    membros: params.get('membros')
  };
}

/* Cria link individual de confirma√ß√£o */
function buildInviteLink(familiaName, membrosList) {
  const base = window.location.origin + window.location.pathname;
  return `${base}?familia=${encodeURIComponent(familiaName)}&membros=${encodeURIComponent(membrosList)}`;
}

/* Valida telefone: s√≥ n√∫meros + tamanho m√≠nimo */
function sanitizePhone(raw) {
  const digits = raw.replace(/\D+/g,'');
  if (digits.length < 10) return null;
  return digits;
}

/* STATE / STORAGE */
let familias = []; // {id, responsavel, membros, telefone}

const STORAGE_KEY = 'conviteMaite_familias_v1';

function loadFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    if (Array.isArray(data)) familias = data;
  } catch(e) {
    console.error('Erro ao carregar storage', e);
  }
}

function saveToStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(familias));
  } catch(e) {
    console.error('Erro ao salvar storage', e);
  }
}

/* RENDERIZA√á√ÉO DA LISTA */
function renderFamilias() {
  const container = $('familiasContainer');
  container.innerHTML = '';

  if (!familias.length) {
    container.innerHTML = '<p>Nenhuma fam√≠lia cadastrada ainda.</p>';
    return;
  }

  familias.forEach((fam) => {
    const div = document.createElement('div');
    div.className = 'familyBox';

    const link = buildInviteLink(fam.responsavel, fam.membros);

    div.innerHTML = `
      <strong>${fam.responsavel}</strong>
      <p>Membros: ${fam.membros}</p>
      <p>Tel: ${fam.telefone}</p>
      <p style="font-size:12px;word-break:break-all;">Link: ${link}</p>
      <div class="fam-actions">
        <button class="fam-btn fam-send" type="button" data-id="${fam.id}">Encaminhar</button>
        <button class="fam-btn fam-edit" type="button" data-id="${fam.id}">Editar</button>
        <button class="fam-btn fam-delete" type="button" data-id="${fam.id}">Excluir</button>
      </div>
    `;

    container.appendChild(div);
  });

  // Delega√ß√£o de eventos
  container.querySelectorAll('.fam-send').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      const fam = familias.find(f => f.id === id);
      if (fam) enviarLinkWhatsApp(fam);
    });
  });

  container.querySelectorAll('.fam-edit').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      openEditModal(id);
    });
  });

  container.querySelectorAll('.fam-delete').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      deleteFamilia(id);
    });
  });
}

/* ADICIONAR FAM√çLIA */
function adicionarFamilia() {
  const responsavel = $('responsavel').value.trim();
  const membros = $('membros').value.trim();
  const telefoneRaw = $('telefone').value.trim();
  const telefone = sanitizePhone(telefoneRaw);

  if (!responsavel || !membros || !telefone) {
    alert('Preencha todos os campos corretamente. Lembre de colocar um telefone v√°lido.');
    return;
  }

  const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
  familias.push({ id, responsavel, membros, telefone });
  saveToStorage();
  renderFamilias();

  $('responsavel').value = '';
  $('membros').value = '';
  $('telefone').value = '';
}

/* EDITAR FAM√çLIA */
let editId = null;

function openEditModal(id) {
  const fam = familias.find(f => f.id === id);
  if (!fam) return;
  editId = id;
  $('editResponsavel').value = fam.responsavel;
  $('editMembros').value = fam.membros;
  $('editTelefone').value = fam.telefone;
  $('editModal').style.display = 'flex';
}

function closeEditModal() {
  editId = null;
  $('editModal').style.display = 'none';
}

function saveEditFamilia() {
  if (!editId) return;
  const fam = familias.find(f => f.id === editId);
  if (!fam) return;

  const responsavel = $('editResponsavel').value.trim();
  const membros = $('editMembros').value.trim();
  const telefoneRaw = $('editTelefone').value.trim();
  const telefone = sanitizePhone(telefoneRaw);

  if (!responsavel || !membros || !telefone) {
    alert('Preencha todos os campos corretamente (telefone com DDD, s√≥ n√∫meros).');
    return;
  }

  fam.responsavel = responsavel;
  fam.membros = membros;
  fam.telefone = telefone;

  saveToStorage();
  renderFamilias();
  closeEditModal();
}

/* EXCLUIR FAM√çLIA */
function deleteFamilia(id) {
  const fam = familias.find(f => f.id === id);
  if (!fam) return;
  const ok = confirm(`Tem certeza que deseja excluir a fam√≠lia de ${fam.responsavel}?`);
  if (!ok) return;
  familias = familias.filter(f => f.id !== id);
  saveToStorage();
  renderFamilias();
}

/* ENVIAR WHATSAPP */
function enviarLinkWhatsApp(fam) {
  const link = buildInviteLink(fam.responsavel, fam.membros);
  const msg = `Oi! Voc√™ est√° convidado(a) para o anivers√°rio da Mait√™! Clique aqui para confirmar sua presen√ßa: ${link}`;

  const zap = `https://wa.me/55${fam.telefone}?text=${encodeURIComponent(msg)}`;

  // Tentativa de abertura
  const win = window.open(zap, '_blank');
  if (!win || win.closed || typeof win.closed === 'undefined') {
    alert('N√£o consegui abrir o WhatsApp. Verifique se o navegador bloqueou pop-ups ou se o n√∫mero est√° correto.');
  }
}

/* Encaminhar todos (abre de 1 em 1 com tempo) */
function enviarTodosWhatsApp() {
  if (!familias.length) {
    alert('N√£o h√° fam√≠lias cadastradas.');
    return;
  }
  const ok = confirm(`Encaminhar link para TODAS as ${familias.length} fam√≠lias? Isso pode abrir v√°rias abas do WhatsApp.`);
  if (!ok) return;

  let idx = 0;
  const delay = 600; // ms entre cada abertura (ajuda a reduzir bloqueio)

  function next() {
    if (idx >= familias.length) {
      alert('Envio conclu√≠do (ou iniciado) ‚Äî confira as abas do navegador / WhatsApp.');
      return;
    }
    enviarLinkWhatsApp(familias[idx]);
    idx++;
    setTimeout(next, delay);
  }
  next();
}

/* EXPORT CSV */
function exportCSV() {
  if (!familias.length) {
    alert('Nada para exportar.');
    return;
  }
  const header = ['Responsavel','Membros','Telefone','Link'];
  const rows = familias.map(f => {
    const link = buildInviteLink(f.responsavel, f.membros);
    return [
      `"${f.responsavel.replace(/"/g,'""')}"`,
      `"${f.membros.replace(/"/g,'""')}"`,
      `"${f.telefone}"`,
      `"${link}"`
    ].join(',');
  });
  const csv = [header.join(','), ...rows].join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'familias_convite_maite.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* CONFIRMA√á√ÉO DE PRESEN√áA */
function confirmarPresenca(familia, membros) {
  alert(`Obrigado! Presen√ßa confirmada para: ${familia} (${membros}). Em breve essa confirma√ß√£o ser√° registrada.`);
}

/* TROCA DE TELAS */
function showHome() {
  $('homeView').hidden = false;
  $('confirmView').hidden = true;
  $('adminArea').style.display = 'none';
}

function showConfirm(familia, membros) {
  $('homeView').hidden = true;
  $('confirmView').hidden = false;
  $('familiaSaudacao').innerHTML = familia
    ? `Ol√°, <strong>${familia}</strong>!<br>Fam√≠lia convidada: ${membros || '‚Äî'}.`
    : `Ol√°! Voc√™ est√° convidado(a)!`;
}

/* EVENTOS GERAIS */
window.addEventListener('DOMContentLoaded', () => {
  loadFromStorage();
  renderFamilias();

  const { familia, membros } = getQueryParams();
  if (familia) {
    showConfirm(familia, membros);
  } else {
    showHome();
  }

  // Bot√£o login abre admin
  $('loginBtn').addEventListener('click', () => {
    $('adminArea').style.display = 'block';
  });

  // Bot√£o voltar para tela inicial
  $('voltarBtn').addEventListener('click', () => {
    showHome();
  });

  // Fechar admin
  document.querySelector('#adminArea .closeBtn').addEventListener('click', () => {
    $('adminArea').style.display = 'none';
  });

  // Adicionar fam√≠lia
  $('addFamiliaBtn').addEventListener('click', adicionarFamilia);

  // Enviar todos
  $('sendAllBtn').addEventListener('click', enviarTodosWhatsApp);

  // Export CSV
  $('exportBtn').addEventListener('click', exportCSV);

  // Confirmar presen√ßa
  $('confirmarBtn').addEventListener('click', () => {
    const { familia, membros } = getQueryParams();
    confirmarPresenca(familia, membros);
  });

  // Edit modal bot√µes
  $('editSaveBtn').addEventListener('click', saveEditFamilia);
  document.querySelector('#editModal .edit-close').addEventListener('click', closeEditModal);
  $('editModal').addEventListener('click', (e) => {
    if (e.target === $('editModal')) closeEditModal();
  });
});
</script>
</body>
</html>

