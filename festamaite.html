<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <title>Festa da Mait√™ - Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --rosa: #d63384;
            --rosa-escuro: #ad2a6b;
            --verde: #28a745;
            --cinza-borda: #dcdcdc;
            --bg-grad: linear-gradient(135deg, #ffe0f0, #ffc4e1);
            --card-bg: #fff;
            --radius-card: 18px;
            --radius-btn: 8px;
            --poppins: 'Poppins', sans-serif;
        }
        body {
            margin: 0;
            font-family: var(--poppins);
            background: var(--bg-grad);
            min-height: 100vh;
            color: #333;
        }
        .center-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--radius-card);
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
            margin: 30px 0;
            text-align: center;
        }
        h1 {
            color: var(--rosa);
            font-size: 2.8rem;
            margin-bottom: 25px;
        }
        .form-section, .list-section {
            margin-top: 30px;
            border-top: 1px solid var(--cinza-borda);
            padding-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            text-align: left;
        }
        input[type="text"],
        input[type="number"],
        textarea {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--cinza-borda);
            border-radius: var(--radius-btn);
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            background-color: var(--rosa);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--radius-btn);
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 5px;
        }
        button:hover {
            background-color: var(--rosa-escuro);
            transform: translateY(-2px);
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #5a6268;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.success {
            background-color: var(--verde);
        }
        button.success:hover {
            background-color: #218838;
        }

        .familia-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: var(--radius-btn);
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
            flex-wrap: wrap;
        }
        .familia-info {
            flex-grow: 1;
        }
        .familia-info strong {
            color: var(--rosa);
            font-size: 1.2rem;
        }
        .familia-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 30px;
            border-radius: var(--radius-card);
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .edit-close {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .edit-close:hover,
        .edit-close:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-body label {
            text-align: left;
            margin-top: 10px;
        }
        .modal-body input[type="text"],
        .modal-body input[type="number"] {
            width: calc(100% - 20px);
        }
        .status-message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="center-wrap">
        <div class="container">
            <h1>Gerenciar Convidados da Mait√™</h1>

            <div class="form-section">
                <h2>Adicionar Nova Fam√≠lia</h2>
                <label for="familiaNome">Nome da Fam√≠lia:</label>
                <input type="text" id="familiaNome" placeholder="Ex: Fam√≠lia Silva" />
                <label for="numMembros">N√∫mero de Membros:</label>
                <input type="number" id="numMembros" min="1" value="1" />
                <button id="addFamiliaBtn">Adicionar Fam√≠lia</button>
            </div>

            <div class="form-section">
                <h2>Sugest√£o de Presente (Edit√°vel)</h2>
                <textarea id="sugestaoPresente"></textarea>
                <button id="saveSugestaoBtn">Salvar Sugest√£o</button>
            </div>

            <div class="list-section">
                <h2>Lista de Fam√≠lias Cadastradas</h2>
                <button id="exportBtn" class="secondary">Exportar CSV</button>
                <div id="familiasContainer">
                    </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="edit-close">&times;</span>
            <h2>Editar Fam√≠lia</h2>
            <div class="modal-body">
                <input type="hidden" id="editFamiliaId">
                <label for="editFamiliaNome">Nome da Fam√≠lia:</label>
                <input type="text" id="editFamiliaNome">
                <label for="editNumMembros">N√∫mero de Membros:</label>
                <input type="number" id="editNumMembros" min="1">
                <button id="editSaveBtn" class="success">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o utilit√°ria para obter elementos
        const $ = id => document.getElementById(id);

        const SUGESTAO_KEY = 'conviteMaite_sugestao_v1';
        const FAMILIAS_KEY = 'conviteMaite_familias_v1';
        let familias = [];

        // #region Fun√ß√µes de Armazenamento e Carga
        function saveFamilias() {
            localStorage.setItem(FAMILIAS_KEY, JSON.stringify(familias));
        }

        function loadFamilias() {
            const storedFamilias = localStorage.getItem(FAMILIAS_KEY);
            familias = storedFamilias ? JSON.parse(storedFamilias) : [];
            renderFamilias();
        }

        function saveSugestaoPresente() {
            const sugestao = $('sugestaoPresente').value;
            localStorage.setItem(SUGESTAO_KEY, sugestao);
            alert('Sugest√£o de presente salva com sucesso!');
        }

        function loadSugestaoPresente() {
            const sugestaoRaw = localStorage.getItem(SUGESTAO_KEY);
            const defaultSugestao = `
                <h3>üéÅ Sugest√£o de Presente:</h3>
                <ul>
                    <li>Roupinhas tamanho 1</li>
                    <li>Sapatinhos n¬∫ 17/18</li>
                    <li>Adora brinquedos!</li>
                </ul>
                <p class="obs">Obs: S√£o apenas sugest√µes! Sua presen√ßa √©, sem d√∫vida, o melhor presente. üíï</p>
            `;
            $('sugestaoPresente').value = sugestaoRaw || defaultSugestao;
        }
        // #endregion

        // #region Fun√ß√µes de Renderiza√ß√£o e UI
        function renderFamilias() {
            const container = $('familiasContainer');
            container.innerHTML = '';
            if (familias.length === 0) {
                container.innerHTML = '<p>Nenhuma fam√≠lia cadastrada ainda.</p>';
                return;
            }
            familias.forEach(fam => {
                const div = document.createElement('div');
                div.classList.add('familia-item');
                div.innerHTML = `
                    <div class="familia-info">
                        <strong>${fam.nome}</strong> (${fam.membros} membros)
                        <br>
                        <span>Link: <a href="${fam.link}" target="_blank">${fam.link.substring(0, 50)}...</a></span>
                    </div>
                    <div class="familia-actions">
                        <button class="fam-send success" data-id="${fam.id}">Enviar Convite</button>
                        <button class="fam-lembrete secondary" data-id="${fam.id}">Enviar Lembrete</button>
                        <button class="fam-edit" data-id="${fam.id}">Editar</button>
                        <button class="fam-delete danger" data-id="${fam.id}">Excluir</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function showStatusMessage(message, isSuccess) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('status-message');
            msgDiv.classList.add(isSuccess ? 'success' : 'error');
            msgDiv.textContent = message;
            $('familiasContainer').before(msgDiv); // Adiciona antes do container de fam√≠lias
            setTimeout(() => msgDiv.remove(), 5000); // Remove ap√≥s 5 segundos
        }
        // #endregion

        // #region Fun√ß√µes de L√≥gica de Neg√≥cio
        function generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateInviteLink(familiaNome, numMembros) {
            const baseUrl = window.location.origin + '/index.html'; // Assume index.html na raiz
            return `${baseUrl}?familia=${encodeURIComponent(familiaNome)}&membros=${encodeURIComponent(numMembros)}`;
        }

        function handleAddFamilia() {
            const nome = $('familiaNome').value.trim();
            const membros = parseInt($('numMembros').value, 10);

            if (!nome || isNaN(membros) || membros <= 0) {
                alert('Por favor, preencha o nome da fam√≠lia e o n√∫mero de membros v√°lidos.');
                return;
            }

            const id = generateUniqueId();
            const link = generateInviteLink(nome, membros);

            familias.push({ id, nome, membros, link, confirmado: false }); // Adiciona 'confirmado' para controle futuro
            saveFamilias();
            renderFamilias();

            $('familiaNome').value = '';
            $('numMembros').value = '1';
            showStatusMessage('Fam√≠lia adicionada com sucesso!', true);
        }

        function handleDeleteFamilia(id) {
            if (confirm('Tem certeza que deseja excluir esta fam√≠lia?')) {
                familias = familias.filter(fam => fam.id !== id);
                saveFamilias();
                renderFamilias();
                showStatusMessage('Fam√≠lia exclu√≠da.', true);
            }
        }

        function openEditModal(id) {
            const fam = familias.find(f => f.id === id);
            if (fam) {
                $('editFamiliaId').value = fam.id;
                $('editFamiliaNome').value = fam.nome;
                $('editNumMembros').value = fam.membros;
                $('editModal').style.display = 'flex';
            }
        }

        function closeEditModal() {
            $('editModal').style.display = 'none';
        }

        function handleSaveEditFamilia() {
            const id = $('editFamiliaId').value;
            const newNome = $('editFamiliaNome').value.trim();
            const newMembros = parseInt($('editNumMembros').value, 10);

            if (!newNome || isNaN(newMembros) || newMembros <= 0) {
                alert('Por favor, preencha o nome da fam√≠lia e o n√∫mero de membros v√°lidos.');
                return;
            }

            const famIndex = familias.findIndex(fam => fam.id === id);
            if (famIndex > -1) {
                const oldLink = familias[famIndex].link;
                familias[famIndex].nome = newNome;
                familias[famIndex].membros = newMembros;
                // Atualiza o link se o nome ou membros mudarem para que o link reflita a edi√ß√£o
                if (!oldLink.includes(`familia=${encodeURIComponent(newNome)}`) || !oldLink.includes(`membros=${encodeURIComponent(newMembros)}`)) {
                    familias[famIndex].link = generateInviteLink(newNome, newMembros);
                }
                saveFamilias();
                renderFamilias();
                closeEditModal();
                showStatusMessage('Fam√≠lia atualizada com sucesso!', true);
            }
        }

        function enviarLinkWhatsApp(fam) {
            const message = `Ol√°, ${fam.nome}! Voc√™ e seus ${fam.membros} membros est√£o convidados para o anivers√°rio de 1 aninho da Mait√™! üéâ\n\nConfirme sua presen√ßa aqui: ${fam.link}\n\nEsperamos voc√™s para celebrar esse momento m√°gico! ‚ú®`;
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function enviarLembreteWhatsApp(fam) {
            const lembreteMessage = `
Oi, amiguinhos e familiares!

Estamos encaminhando esta mensagem porque o prazo de confirma√ß√£o da presen√ßa na festinha da Mait√™ est√° se aproximando e ainda n√£o recebemos a sua resposta.

Como a lista de convidados √© bem curtinha, precisamos muito saber quem poder√° vir para que tudo seja organizado com carinho e aten√ß√£o.

Se puder confirmar o quanto antes, agradecemos demais!

E, se n√£o puder comparecer, n√£o tem problema, s√≥ pedimos que nos avise tamb√©m.

Beijinhos,

Fam√≠lia da Mait√™

Confirme sua presen√ßa aqui: ${fam.link}
            `;
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(lembreteMessage.trim())}`;
            window.open(whatsappUrl, '_blank');
        }

        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Nome da Familia,Numero de Membros,Link do Convite,Confirmado\n"; // Header

            familias.forEach(fam => {
                let row = `${fam.id},"${fam.nome}",${fam.membros},"${fam.link}",${fam.confirmado ? 'Sim' : 'N√£o'}\n`;
                csvContent += row;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "convidados_maite.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link);
            showStatusMessage('Dados exportados para CSV.', true);
        }

        // Esta fun√ß√£o seria para a integra√ß√£o com o Google Sheet, mas o front-end sozinho n√£o pode fazer isso por seguran√ßa.
        // A l√≥gica de "n√£o ter mais a op√ß√£o de confirmar" precisaria de uma integra√ß√£o backend robusta com a planilha.
        // Por enquanto, o bot√£o de confirma√ß√£o no formul√°rio sempre estar√° vis√≠vel.
        function verificarConfirmacaoGoogleSheet(familiaNome, membros) {
            // Esta √© uma fun√ß√£o placeholder. A l√≥gica real exigiria:
            // 1. Um Google Apps Script que l√™ a planilha e retorna o status de confirma√ß√£o.
            // 2. Uma chamada fetch deste frontend para esse Apps Script.
            console.log(`Verificando confirma√ß√£o para ${familiaNome} (${membros})... (Funcionalidade de backend)`);
            return false; // Retorna false por padr√£o, pois n√£o h√° integra√ß√£o ativa aqui.
        }
        // #endregion

        // #region Event Listeners
        window.addEventListener('DOMContentLoaded', () => {
            loadFamilias();
            loadSugestaoPresente(); // Carrega a sugest√£o ao carregar a p√°gina admin
            $('addFamiliaBtn').addEventListener('click', handleAddFamilia);
            $('exportBtn').addEventListener('click', exportCSV);
            // Removido: $('enviarTodosBtn').addEventListener('click', ...);
            $('saveSugestaoBtn').addEventListener('click', saveSugestaoPresente); // Bot√£o para salvar a sugest√£o

            // Delegated event listener for family actions
            $('familiasContainer').addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                const fam = familias.find(f => f.id === id);

                if (e.target.classList.contains('fam-send')) {
                    if (fam) enviarLinkWhatsApp(fam);
                } else if (e.target.classList.contains('fam-lembrete')) {
                    if (fam) enviarLembreteWhatsApp(fam);
                } else if (e.target.classList.contains('fam-edit')) {
                    openEditModal(id);
                } else if (e.target.classList.contains('fam-delete')) {
                    handleDeleteFamilia(id);
                }
            });

            $('editSaveBtn').addEventListener('click', handleSaveEditFamilia);
            document.querySelector('#editModal .edit-close').addEventListener('click', closeEditModal);
            $('editModal').addEventListener('click', (e) => {
                if (e.target === $('editModal')) closeEditModal();
            });
        });
        // #endregion
    </script>
</body>
</html>
