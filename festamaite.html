<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Festa da Maitê</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- (Estilos mantidos como estão acima, por brevidade) -->
<style>
  /* ... estilos anteriores mantidos ... */
</style>
</head>
<body>

<!-- TELA HOME -->
<div id="homeView" class="center-wrap" >
  <div class="card">
    <h1>Festa da Maitê 🎉</h1>
    <p>Estamos muito felizes em celebrar o 1º aninho da nossa princesa Maitê! 💜</p>
    <p>
      Mamãe ou papai, estamos muito felizes em ajudar vocês com a festa da Maitê!<br>
      Este espaço foi personalizado para facilitar o envio dos convites, acompanhar as confirmações de presença e tornar esse momento ainda mais especial.
    </p>
    <button id="loginBtn" class="btn" type="button">LOGIN</button>
  </div>
</div>

<!-- TELA CONFIRMAÇÃO -->
<div id="confirmView" class="center-wrap" hidden>
  <div class="card" id="confirmCard">
    <h1>Maitê faz 1 aninho! 👧🎉</h1>
    <p id="familiaSaudacao"></p>
    <p>
      🗓️ <strong>Data:</strong> 20 de Setembro<br>
      🕒 <strong>Horário:</strong> das 19:30 às 23:30<br>
      📍 <strong>Local:</strong> Avenida São Miguel, 8001 - SP
    </p>
    <div id="sugestoesPresente" style="display:none; text-align:left; margin-top: 20px; background:#fff0f8; border-radius: 12px; padding: 16px;">
      <h3>🎁 Sugestão de presente:</h3>
      <p id="textoPresente"></p>
    </div>
    <button id="confirmarBtn" class="btn" type="button">Confirmar Presença</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminArea" hidden>
  <button id="voltarBtn" type="button">Voltar à tela inicial</button>
  <button class="closeBtn" type="button" aria-label="Fechar Admin">&times;</button>
  <div class="admin-inner">
    <h2>Cadastro de Famílias</h2>

    <div class="admin-form">
      <label for="responsavel">Responsável (Ex: Sueli)</label>
      <input id="responsavel" placeholder="Responsável" />

      <label for="membros">Membros (Ex: Sueli, Adilson, Eduardo)</label>
      <textarea id="membros" placeholder="Membros separados por vírgula"></textarea>

      <label for="telefone">Telefone com DDD (somente números)</label>
      <input id="telefone" placeholder="Ex: 11999999999" />

      <label for="presente">Sugestão de presente (opcional)</label>
      <textarea id="presente" placeholder="Ex: Roupa número 1, Sapato 17/18, Gosto de brinquedos"></textarea>

      <div class="admin-actions">
        <button class="admin-btn add" type="button" id="addFamiliaBtn">Adicionar Família</button>
        <button class="admin-btn mass" type="button" id="exportBtn" title="Exportar em CSV">Exportar CSV</button>
      </div>
    </div>

    <div id="familiasContainer"></div>
  </div>
</div>

<!-- MODAL EDIÇÃO -->
<div id="editModal">
  <div class="edit-content">
    <button class="edit-close" type="button" aria-label="Fechar edição">&times;</button>
    <h3>Editar Família</h3>
    <label for="editResponsavel">Responsável</label>
    <input id="editResponsavel" />
    <label for="editMembros">Membros</label>
    <textarea id="editMembros"></textarea>
    <label for="editTelefone">Telefone</label>
    <input id="editTelefone" />
    <label for="editPresente">Sugestão de Presente</label>
    <textarea id="editPresente"></textarea>
    <button class="edit-save" type="button" id="editSaveBtn">Salvar Alterações</button>
  </div>
</div>

<script>
function $(id) { return document.getElementById(id); }

function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    familia: params.get('familia'),
    membros: params.get('membros')
  };
}

function buildInviteLink(familiaName, membrosList) {
  const base = window.location.origin + "/convite-maite/";
  return `${base}?familia=${encodeURIComponent(familiaName)}&membros=${encodeURIComponent(membrosList)}`;
}

function sanitizePhone(raw) {
  const digits = raw.replace(/\D+/g,'');
  if (digits.length < 10) return null;
  return digits;
}

let familias = [];
const STORAGE_KEY = 'conviteMaite_familias_v1';

function loadFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    if (Array.isArray(data)) familias = data;
  } catch(e) { console.error('Erro ao carregar storage', e); }
}

function saveToStorage() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(familias)); }
  catch(e) { console.error('Erro ao salvar storage', e); }
}

function renderFamilias() {
  const container = $('familiasContainer');
  container.innerHTML = '';
  if (!familias.length) {
    container.innerHTML = '<p>Nenhuma família cadastrada ainda.</p>';
    return;
  }
  familias.forEach((fam) => {
    const div = document.createElement('div');
    div.className = 'familyBox';
    const link = buildInviteLink(fam.responsavel, fam.membros);
    div.innerHTML = `
      <strong>${fam.responsavel}</strong>
      <p>Membros: ${fam.membros}</p>
      <p>Tel: ${fam.telefone}</p>
      <p>Presente: ${fam.presente || '—'}</p>
      <p style="font-size:12px;word-break:break-all;">Link: ${link}</p>
      <div class="fam-actions">
        <button class="fam-btn fam-send" type="button" data-id="${fam.id}">Encaminhar</button>
        <button class="fam-btn fam-edit" type="button" data-id="${fam.id}">Editar</button>
        <button class="fam-btn fam-delete" type="button" data-id="${fam.id}">Excluir</button>
      </div>`;
    container.appendChild(div);
  });
  container.querySelectorAll('.fam-send').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      const fam = familias.find(f => f.id === id);
      if (fam) enviarLinkWhatsApp(fam);
    });
  });
  container.querySelectorAll('.fam-edit').forEach(btn => {
    btn.addEventListener('click', () => openEditModal(btn.getAttribute('data-id')));
  });
  container.querySelectorAll('.fam-delete').forEach(btn => {
    btn.addEventListener('click', () => deleteFamilia(btn.getAttribute('data-id')));
  });
}

function adicionarFamilia() {
  const responsavel = $('responsavel').value.trim();
  const membros = $('membros').value.trim();
  const telefone = sanitizePhone($('telefone').value.trim());
  const presente = $('presente').value.trim();
  if (!responsavel || !membros || !telefone) {
    alert('Preencha todos os campos corretamente.'); return;
  }
  const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
  familias.push({ id, responsavel, membros, telefone, presente });
  saveToStorage(); renderFamilias();
  ['responsavel','membros','telefone','presente'].forEach(id => $(id).value = '');
}

let editId = null;
function openEditModal(id) {
  const fam = familias.find(f => f.id === id);
  if (!fam) return;
  editId = id;
  $('editResponsavel').value = fam.responsavel;
  $('editMembros').value = fam.membros;
  $('editTelefone').value = fam.telefone;
  $('editPresente').value = fam.presente || '';
  $('editModal').style.display = 'flex';
}
function closeEditModal() { editId = null; $('editModal').style.display = 'none'; }
function saveEditFamilia() {
  if (!editId) return;
  const fam = familias.find(f => f.id === editId);
  fam.responsavel = $('editResponsavel').value.trim();
  fam.membros = $('editMembros').value.trim();
  fam.telefone = sanitizePhone($('editTelefone').value.trim());
  fam.presente = $('editPresente').value.trim();
  saveToStorage(); renderFamilias(); closeEditModal();
}

function deleteFamilia(id) {
  if (confirm('Tem certeza?')) {
    familias = familias.filter(f => f.id !== id);
    saveToStorage(); renderFamilias();
  }
}

function enviarLinkWhatsApp(fam) {
  const link = buildInviteLink(fam.responsavel, fam.membros);
  const msg = `🌟✨ Olá, amiguinhos e familiares queridos! ✨🌟\n\nO meu aniversário está chegando e, com o coração cheio de alegria, venho convidar você para fazer parte desse momento mágico! 🎂🥳💖\nA sua presença é muito especial para nós, e tornará esse dia ainda mais encantado!\n\nSabemos que nem todos poderão estar presentes, e tudo bem… vamos entender com muito carinho. 💌\nMas por isso mesmo, é super importante que cada pessoa confirme sua presença individualmente 👤, para que possamos organizar tudinho com amor e deixar essa festa inesquecível!\n\n🔔 Importante: A confirmação precisa ser feita em até 5 dias úteis após o envio deste convite.\nCaso não recebamos resposta dentro do prazo, entenderemos como uma ausência e, para que ninguém fique de fora, incluiremos outros convidados no lugar.\n\n✨ Os nomes confirmados serão enviados para a assessoria do Salão Kidáhora dentro desse prazo mágico!\n\n📩 Clique no ícone de confirmação no convite para nos avisar se você vem celebrar com a gente!\n\n${link}\n\nCom carinho,\nMaitê 💕🧁🎈`;
  const url = `https://wa.me/55${fam.telefone}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

function confirmarPresenca(familia, membros) {
  const fam = familias.find(f => f.responsavel.toLowerCase() === (familia || '').toLowerCase());
  if (fam && fam.presente) {
    $('sugestoesPresente').style.display = 'block';
    $('textoPresente').innerText = fam.presente;
  }
  alert(`Obrigado! Presença confirmada para: ${familia || 'Família convidada'}.`);
}

function showHome() {
  $('homeView').hidden = false;
  $('confirmView').hidden = true;
  $('adminArea').style.display = 'none';
}
function showConfirm(familia, membros) {
  $('homeView').hidden = true;
  $('confirmView').hidden = false;
  $('familiaSaudacao').innerHTML = familia
    ? `Olá, <strong>${familia}</strong>!<br>Família convidada: ${membros || '—'}.`
    : `Olá! Você está convidado(a)!`;
}

window.addEventListener('DOMContentLoaded', () => {
  loadFromStorage(); renderFamilias();
  const { familia, membros } = getQueryParams();
  if (familia) showConfirm(familia, membros);
  else showHome();
  $('loginBtn').addEventListener('click', () => $('adminArea').style.display = 'block');
  $('voltarBtn').addEventListener('click', showHome);
  document.querySelector('#adminArea .closeBtn').addEventListener('click', () => $('adminArea').style.display = 'none');
  $('addFamiliaBtn').addEventListener('click', adicionarFamilia);
  $('exportBtn').addEventListener('click', exportCSV);
  $('confirmarBtn').addEventListener('click', () => {
    const { familia, membros } = getQueryParams();
    confirmarPresenca(familia, membros);
  });
  $('editSaveBtn').addEventListener('click', saveEditFamilia);
  document.querySelector('#editModal .edit-close').addEventListener('click', closeEditModal);
  $('editModal').addEventListener('click', e => { if (e.target === $('editModal')) closeEditModal(); });
});
</script>
</body>
</html>
